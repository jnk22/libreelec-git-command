#!/usr/bin/env bash
#
# Wrapper to run git using a Docker container.

docker_bin=$(command -v docker || echo "$HOME/.kodi/addons/service.system.docker/bin/docker")
if [[ ! -x "$docker_bin" ]]; then
  echo "docker binary not found or not executable" >&2
  exit 1
fi

# Passthrough SSH_AUTH_SOCK if set on host.
ssh_agent_mount=()
if [[ -S "$SSH_AUTH_SOCK" ]]; then
  ssh_agent_mount=(--volume "$SSH_AUTH_SOCK:$SSH_AUTH_SOCK" --env SSH_AUTH_SOCK="$SSH_AUTH_SOCK")
fi

# Mount additional SSH and Git configurations if available on host.
config_volumes=()
for path in .ssh .gitconfig .config/git; do
  if [[ -f "$path" || -d "$path" ]]; then
    config_volumes+=(--volume "$HOME/$path:/$path:ro")
  fi
done

"$docker_bin" run --rm -it \
  --user "$(id -u):$(id -g)" \
  --volume "$PWD":"$PWD" \
  "${config_volumes[@]}" \
  "${ssh_agent_mount[@]}" \
  --workdir "$PWD" \
  "${IMAGE_NAME:-alpine/git}:${IMAGE_TAG:-latest}" \
  "$@"
